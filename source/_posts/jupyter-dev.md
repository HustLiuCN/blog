---
title: Jupyter Lab 二次开发
date: 2020-09-15 14:24:44
tags: Jupyter, 机器学习, 数据分析, 前端
---

Jupyter 是目前来说数据分析、机器学习领域首屈一指的开源解决方案，提供交互式开发计算平台，而各家厂商也纷纷将其搭载于自家平台，为用户提供在线的计算、托管平台。诸如**[Google Colab](https://colab.research.google.com/)**，**[阿里云天池](https://tianchi.aliyun.com/)**等等，包括**Netflix**，**百度**，**美团**等大厂也有诸多基于Notebook的解决方案经验提炼总结，贡献到开源社区

无论是技术追新，还是紧跟行业趋势，我们部门作为公司最核心的数据架构组，也从大概去年开始着手打造自己的Jupyter平台，目标是朝着Colab努力……

<!-- more -->

## 趋势

前面提到，目前了解到的国内外的解决方案，均是基于 Notebook，当然像Google、阿里云这种超级大厂，基本上是利用了Notebook的内核，然后上层完全搭建了一套自己的产品体系。这个在我们团队前端人力只有我一人的前提下，显然不太可行
再者，虽然Notebook是主流方案，但关注社区动态就会发现Jupyter Lab才是社区主推的未来趋势，所以经过权衡，最终决定以Lab为重心开发，Notebook作为辅助功能来实现一些其他需求场景

## 分工

前面提到，将Lab核心场景来进行开发。而Lab的产品形态我们可以将其简单理解为一个在线的VSCode，提供了**编辑器、文件系统、插件、插件扩展**等一系列原生功能以及扩展API，而探索了解Jupyter Lab的插件生态之后，你也会感叹整个Jupyter技术生态之庞大与完善

所以说Lab在我们系统中的使命就是承载用户所有的开发过程，这也是最为主要的一个用户场景

Notebook则用来承载一些分享、协作、展示类的辅助功能，大部分场景是只读状态，只提供基本的修改功能。这也是充分利用其简易、轻便的特点，同时也参考了如阿里云天池这样的优秀案例，综合得出的解决方案

与此同时，我们还搭建了一套内容管理平台，方便用户管理自己的项目以及可以参阅整个用户群共享出来的优质内容，包括**文件模板、代码片段**等等，同时提供有**fork、收藏、分享、一键应用**等快捷入口。这些都是充分参考了社区优质案例，以及结合内部用户需求反馈而制定的方案

## 难点

### 多端的并行与共存

之前提到我们的Jupyter项目其实是包含了Lab、Notebook、以及一个内容端，在项目初期，Lab与Notebook几乎是完全镜像的存在，相当于给用户提供了两个类似的产品，而由于历史原因，二者的用户均有一定的粘性，很难立刻一刀切的迁移到Lab

同时内容管理端也有些功能与两个开发端重合，所以这个阶段的功能开发基本上是一段开发，三端适配。而Lab的技术栈是React+TypeScript，Notebook是jQuery+RequireJS，内容管理端作为公司生态体系一员，则是Vue。适配兼容难度可见一斑

#### 解决方案

这里我思考过两个解决方案，一个是通过编译来解决兼容问题，一个是直接用原生JS来开发，以lib的形式引入。后者是前者的一个步骤，而且将React与Vue来回转换编译，同时还得考虑jQuery的兼容性，难免有些削足适履。所以经过权衡与一些可行性调研之后，我决定采用第二个方案。因为整个项目前端都是我独立负责，所以在技术方案的制定这部分也相对比较容易


### 版本老旧

在多端并行了一段时间之后，随着功能开发的展开，对原生Jupyter的侵入越来越深入，遇到的问题也越来越多。这个时候一个最棘手的难题就是我们的Lab版本过于陈旧，前面提到，Lab是我们的重点场景以及开发对象，而如果一直维持着旧版本，就很难利用到社区资源以及新的特性

举例来说，我们的版本是0.35.x，而官方最新的stable版本是2.2.x，差距肉眼可见的大，这个时候你遇到的问题都是被社区所遗弃的一些问题，比如一个Safari的兼容性问题，是官方确认的bug，在1.2.x版本之后修复了，如果我们不能跟进版本，就需要对照官方解决方案去自己适配，这个成本显而易见，尤其是人力有限且需求旺盛的情况下，更是难以为继

#### 解决方案

长痛不如短痛。在我做了一番调研以及尝试开发了一些Demo之后，决定升级版本，跟进社区。这部分主要的工作都在前端，因为Lab是一个重前端驱动的产品，后端的升级改动微乎其微，而我们自己的服务又都是通用的

做出决定后，首先是取舍问题。目前的人力而言，版本升级很难在Lab与Notebook上同时进行，于是有了文章一开始提到的「分工」这个决策，这也是参考许多业内优秀的产品而制定的方案。Notebook作为一个内容展示的载体，暂时并没有太迫切的升级诉求。而Lab的升级，则主要是新的API适配以及旧的已开发插件迁移这两个重点

迁移部分工作的进展比预期要顺利，基本上在保持旧版本日常维护的前提下，花费了三周左右的时间就完成了大部分的旧功能迁移，跟上了社区最新版本。总体而言是体力活，当然，在迁移的过程中也伴随着大量的重构，这也是参考了新的Lab的一些框架理念而做出的优化改造，收益也比较明显，整体的插件扩展性明显有了改善，后续的功能开发相比于之前可以说是事半功倍
